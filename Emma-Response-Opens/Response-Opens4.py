import pyodbc
import requests
import datetime

#print time
datetime.time(15, 8, 24)
print("Script began at: ", datetime.datetime.now().time())

#connect to server and db 
cnxn = pyodbc.connect("Driver={SQL Server};"
                        "Server=devsql01;"
                        "Database=MyEmma;"
                        "Trusted_Connection=yes;")

cursor = cnxn.cursor()
    
def apiConnect(pubApi, privApi, accountId, start, end, mailingid):

    #pull in and authenticate API and convert into proper JSON format
    api = requests.get('https://api.e2ma.net/' + accountId + '/response/' + mailingid + '/opens?start=' + start + '&end=' + end, auth=(pubApi, privApi))
    api= api.json()
    
    #iterate through JSON object
    for x in api:

    #allocate parsed json value to variable, and if exception then give NULL value to variable
        try:
            storeCode = x['fields']['storecode']
        except:
            storeCode = None
            
        try:
            firstName = x['fields']['first_name']
        except:
            firstName = None

        try: 
            lastName = x['fields']['last_name']
        except:
            lastName = None

        try:
            lastInputSource = x['fields']['last-input-source']
        except: 
            lastInputSource = None

        try:
            fishbowlJoinDate = x['fields']['fishbowl-join-date'].replace("@D:","")
        except:
            fishbowlJoinDate = None

        try:
            pxOrOtJoindate = x['fields']['px-or-ot-joindate'].replace("@D:","")
        except:
            pxOrOtJoindate = None

        try:
            otSignup = x['fields']['ot-signup']
        except:
            otSignup = None
            
        try:
            pxCardNumber = x['fields']['pxcardnumber']
        except:
            pxCardNumber = None
            
        try: 
            dateLastDined = x['fields']['datelastdined'].replace("@D:","")
        except:
            dateLastDined = None
            
        try:
            birthDay = x['fields']['birthdate'].replace("@D:","")
        except:
            birthDay = None
            
        try:
            memberSince = x['member_since'].replace("@D:","")
            memberSince = memberSince.replace("T"," ")
        except:
            memberSince = None
            
        try:
            timeStamp = x['timestamp'].replace("@D:","")
            timeStamp = timeStamp.replace("T"," ")
        except:
            timeStamp = None
            
        
        #insert parsed JSON values into DB and pass params for stored procedure
        query = "exec MyemmaResponseOpens @storecode = ?, @firstname = ?, @lastname = ?, @px_or_ot_joindate = ?, @datelastdined = ?, @pxcardnumber = ?, @birthdate = ?, @fishbowl_join_date = ?, @ot_signup = ?, @last_input_source = ?, @timestamp = ?, @member_id = ?, @member_since = ?, @email_domain = ?, @email_user = ?, @email = ?, @member_status_id = ?, @mailing_id = ?"
        values = (storeCode, firstName, lastName, pxOrOtJoindate, dateLastDined, pxCardNumber, birthDay, fishbowlJoinDate, otSignup, lastInputSource, timeStamp, x['member_id'], memberSince, x['email_domain'], x['email_user'], x['email'], x['member_status_id'], mailingid)
        cursor.execute(query, values)            
        cnxn.commit()


#new function which passes params and calls other function for each store/brand with the necessary exception handle in place
def funcCall(start, end):
    
    arr = ['576668703', '587212831', '624056351', '624651295', '638447647', '652710943', '673238047', '680907807', '681595935', '687345695', '687938591', '688760863', '688774175', '693819423', '701359135', '702412831', '702658591', '726525983', '727567391', '733341727', '735091743', '735092767', '746809375', '758843423', '758844447', '562111519', '604507167', '604885023', '623911967', '680908831', '680909855', '687360031', '693788703', '700489759', '701620255', '701664287', '702547999', '703451167', '712342559', '722651167', '722664479', '726538271', '726539295', '727568415', '727569439', '727570463', '733340703', '733638687', '746808351', '754390047', '758841375', '758853663', '576669727', '604506143', '604886047', '623907871', '624652319', '624653343', '652208159', '679937055', '681599007', '687535135', '687898655', '695903263', '700510239', '701333535', '702657567', '703521823', '703522847', '716641311', '717512735', '718941215', '720607263', '733639711', '754289695', '758842399', '760897567', '586316831', '591992863', '592244767', '652204063', '667152415', '667456543', '673252383', '679938079', '688754719', '701370399', '701659167', '712343583', '712344607', '712594463', '716624927', '720606239', '722654239', '722669599', '727627807', '727628831', '754391071', '758854687']
    
    for j in arr:

        try:
            apiConnect('', '', '', start, end, j)
        except Exception as e:
            print("Error Message: ", e)  
            
            
    arr = ['35182621', '35183645', '35184669', '35197981', '35199005', '35348509', '35395613', '35438621', '35467293', '35472413', '35635229', '35636253', '35647517', '35648541', '35869725', '35890205', '35906589', '35928093', '35929117', '36100125', '36220957', '36409373', '36412445', '36580381', '36581405', '36624413', '36647965', '36674589', '36680733', '36716573', '37237789', '37392413', '37393437', '37394461', '37395485', '37797917', '38103069', '38107165', '38121501', '38141981', '38146077', '38176797', '38177821', '38182941', '38213661', '38218781', '38386717', '38417437', '38425629', '38445085', '38485021', '38491165', '38496285', '38530077', '38540317', '38559773', '38560797', '38579229', '38583325', '38584349', '38802461', '38803485', '38804509', '38860829', '38900765', '38912029', '38931485', '38960157', '39126045', '39127069', '39129117', '39204893', '39205917', '39206941', '39207965', '39274525', '39275549', '39362589', '39363613', '39635997', '39637021', '39638045', '39639069', '39650333', '39651357', '39653405', '39654429', '39845917', '39846941', '39994397', '39995421', '40433693', '40434717', '40675357', '40676381', '40680477', '40839197', '40840221', '41416733', '41417757', '42765341', '42766365', '42969117', '42970141', '43812893', '43880477']
    
    for j in arr:

        try:
            apiConnect('', '', '', start, end, j)
        except Exception as e:
            print("Error Message: ", e)    
                
            
    arr = ['14524444', '14537756', '14538780', '14543900', '14545948', '14596124', '14606364', '14720028', '14721052', '14790684', '14793756', '14809116', '14848028', '14849052', '14850076', '14911516', '15010844', '15118364', '15119388', '15263772', '15276060', '15284252', '15311900', '15312924', '16235548', '16261148', '16469020', '16471068', '16606236', '16608284', '16609308', '16615452', '16706588', '16707612', '16742428', '16747548', '16986140', '17041436', '17107996', '17112092', '17114140', '17174556', '17241116', '17682460', '17683484', '17684508', '17725468', '17758236', '18034716', '18035740', '18060316', '18061340', '18423836', '18424860', '18698268', '18699292', '18700316', '19274780', '19275804', '19276828', '19277852', '19403804', '19404828', '19538972', '19539996', '19843100', '20924444', '20925468', '20926492', '21194780', '21195804', '21363740', '21364764', '21940252', '21973020']
    
    for j in arr:

        try:
            apiConnect('', '', '', start, end, j)
        except Exception as e:
            print("Error Message: ", e)    
            
            
    arr = ['101176290', '101262306', '101336034', '101337058', '101341154', '103136226', '103137250', '109109218', '109110242', '109124578', '109125602', '109134818', '115787746', '115789794', '116746210', '116932578', '116933602', '116956130', '116957154', '116958178', '116959202', '118144994', '118146018', '119936994', '120128482', '120131554', '122100706', '122295266', '122298338', '122907618', '122908642', '123632610', '123749346', '123758562', '123770850', '125085666', '125165538', '125286370', '125287394', '126201826', '126205922', '126333922', '126722018', '127110114', '127111138', '127905762', '127906786', '127923170', '127989730', '128089058', '128090082', '128100322', '128194530', '129581026', '129582050', '131485666', '131486690', '131487714', '132454370', '132455394', '132776930', '132782050', '133470178', '133471202', '133796834', '133797858', '134956002', '135118818', '135119842', '138510306', '138513378', '140322786', '94926818', '95012834', '95703010', '97555426', '98023394', '98024418', '98034658', '98183138', '98192354', '98193378', '99502050', '99807202']
    
    for j in arr:

        try:
            apiConnect('', '', '', start, end, j)
        except Exception as e:
            print("Error Message: ", e)    
    
    arr = ['136149011', '136153107', '136174611', '136265747', '136267795', '136268819', '136286227', '136309779', '136314899', '136315923', '136316947', '136317971', '136333331', '136334355', '136350739', '136351763', '136352787', '136364051', '136398867', '136400915', '136419347', '136431635', '136432659', '136434707', '136435731', '136441875', '136442899', '136443923', '136596499', '136597523', '136598547', '136604691', '136632339', '136633363', '136634387', '136635411', '136646675', '136647699', '136649747', '136700947', '136710163', '136711187', '136712211', '136713235', '136752147', '136753171', '136835091', '136890387', '136891411', '136928275', '136933395', '136973331', '136974355', '136975379', '137015315', '137083923', '137094163', '137104403', '137115667', '137116691', '137239571', '138540051', '138653715', '138911763', '138912787', '138915859', '138924051', '138947603', '138948627', '139513875', '139514899', '139536403', '139537427', '139541523', '139587603', '139597843', '139776019', '139802643', '139809811', '139824147', '139825171', '139866131', '139868179', '139869203', '139871251', '139910163', '139918355', '140486675', '140487699', '140488723', '140505107', '140506131', '140516371', '140517395', '140739603', '140740627', '140741651', '140821523', '140827667', '140851219', '140854291', '140953619', '140994579', '141740051', '141741075', '141789203', '141790227', '141791251', '141792275', '141902867', '141903891', '141967379', '141972499', '141973523', '141974547', '141975571', '142167059', '142168083', '142169107', '142170131', '142171155', '142172179', '142240787', '142241811', '142507027', '142508051', '142528531', '142529555', '142635027', '142636051', '143685651', '143686675', '143853587', '143854611', '143858707', '143981587', '143982611', '143984659', '143985683', '144387091', '144388115', '146109459', '146110483', '146381843', '146481171', '146482195', '146650131', '146651155', '146786323', '146787347', '147021843', '147863571', '147866643']
            
    for j in arr:

        try:
            apiConnect('', '', '', start, end, j)
        except Exception as e:
            print("Error Message: ", e)    
            
            
    arr = ['39395351', '39441431', '39442455', '39489559', '39605271', '39606295', '39617559', '39644183', '39687191', '39868439', '39869463', '40112151', '40116247', '40142871', '40223767', '40224791', '40225815', '40395799', '40665111', '40666135', '40689687', '40690711', '40691735', '41025559', '41164823', '41167895', '41168919', '41169943', '41306135', '41400343', '41410583', '41464855', '41468951', '41536535', '42988567', '42995735', '43001879', '43098135', '43106327', '43110423', '43175959', '43230231', '43249687', '43259927', '43420695', '43426839', '43482135', '43487255', '43511831', '43760663', '43761687', '43762711', '43768855', '43774999', '43783191', '43937815', '43938839', '43951127', '43953175', '43959319', '43960343', '44063767', '44064791', '44105751', '44106775', '44561431', '44562455', '44728343', '44729367', '44905495', '44906519', '45280279', '46080023', '46248983', '46250007', '46455831', '46456855', '46486551', '46487575', '46722071', '46723095', '47030295', '47031319', '47566871']
    
    for j in arr:

        try:
            apiConnect('', '', '', start, end, j)
        except Exception as e:
            print("Error Message: ", e)    
#function call
funcCall('0','500')
funcCall('500','1000')
funcCall('1000','1500')
funcCall('1500','2000')
funcCall('2000','2500')
funcCall('2500','3000')
funcCall('3000','3500')
funcCall('3500','4000')
funcCall('4000','4500')
funcCall('4500','5000')
funcCall('5000','5500')
funcCall('5500','6000')
funcCall('6000','6500')
funcCall('6500','7000')
funcCall('7000','7500')
funcCall('7500','8000')
funcCall('8000','8500')
funcCall('8500','9000')
funcCall('9000','9500')
funcCall('9500','10000')


#print time
print("Script finished running at: ", datetime.datetime.now().time())